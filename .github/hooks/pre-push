#!/bin/bash
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

CHANGED=""
if git diff --name-only "@{push}..HEAD" 2>/dev/null | grep -q "^hope/"; then
  CHANGED="hope"
elif git diff --name-only "origin/main..HEAD" 2>/dev/null | grep -q "^hope/"; then
  CHANGED="hope"
fi

if [ -z "$CHANGED" ]; then
  echo "✓ No plugin changes, skipping eval"
  exit 0
fi

ERRORS=""

plugin_dir="$REPO_ROOT/hope"
[ ! -d "$plugin_dir/skills" ] && exit 0

for skill_file in "$plugin_dir"/skills/*/SKILL.md; do
  [ ! -f "$skill_file" ] && continue

  lines=$(wc -l < "$skill_file" | tr -d ' ')
  if [ "$lines" -gt 200 ]; then
    ERRORS="${ERRORS}${skill_file}: ${lines} lines (max 200)\n"
  fi

  skill_dir=$(dirname "$skill_file")
  if [ -d "$skill_dir/references" ]; then
    ERRORS="${ERRORS}${skill_dir}: has references/ directory (use flat files)\n"
  fi

  if ! head -1 "$skill_file" | grep -q '^---$'; then
    ERRORS="${ERRORS}${skill_file}: missing frontmatter\n"
  fi

  if head -20 "$skill_file" | grep -qE '^description:\s*[|>]'; then
    ERRORS="${ERRORS}${skill_file}: multi-line description (use single line)\n"
  fi
done

if [ -n "$ERRORS" ]; then
  echo "=== Skill Validation Errors ==="
  echo -e "$ERRORS"
  exit 1
fi

echo "✓ Skill validation passed"
